var COLORTHRESH=45,PSYCHWAITTIME=8E3,detectionOptions={withLandmarks:!0,withDescriptors:!1},app={pixelSize:3,cthresh:0,useShader:!1,ns:.01,rotate:!0,faceOnly:!0,skinColor:null,meltLength:75,meltTime:17500},faceapi,detections,poseNet,pose,faceX=0,faceY=0,faceW=0,faceH=0,init=!1,pg=null;
function setup(){createCanvas(640,480);pg=createGraphics(640,480);capture=createCapture(VIDEO,videoReady);capture.hide();poseNet=ml5.poseNet(capture,modelLoaded);poseNet.on("pose",gotPoses);faceapi=ml5.faceApi(capture,detectionOptions,modelReady);app.cthresh=COLORTHRESH;colorMode(RGB,255)}function videoReady(){init=!0}function modelLoaded(){console.log("poseNet ready")}function modelReady(){console.log("faceapi ready!");console.log(faceapi);faceapi.detect(gotResults)}
function gotResults(a,b){a?console.log(a):((detections=b)&&0<detections.length&&drawBox(detections),faceapi.detect(gotResults))}function drawBox(a){for(var b=0;b<a.length;b+=1){var c=a[b].alignedRect;faceX=c._box._x;faceY=c._box._y;faceW=c._box._width;faceH=c._box._height}}
function gotPoses(a){if(0<a.length){pose=a[0].pose;a=getLocColor(Math.round(pose.nose.x),Math.round(pose.nose.y));var b=getLocColor(Math.round(pose.leftEye.x),Math.round(pose.nose.y)),c=getLocColor(Math.round(pose.rightEye.x),Math.round(pose.nose.y));app.skinColor=color(Math.round((red(a)+red(b)+red(c))/3),Math.round((green(a)+green(b)+green(c))/3),Math.round((blue(a)+blue(b)+blue(c))/3))}}
function draw(){if(init&&app.skinColor){var a=app.ns,b=capture.get(),c=app.skinColor,d=Math.round(faceX),e=Math.round(faceY),f=Math.round(faceW),h=Math.round(faceH);pg=createGraphics(640,480);app.faceOnly||(e=d=0,f=capture.width,h=capture.height);capture.loadPixels();for(var g=d;g<d+f;g+=app.pixelSize)for(var k=e;k<e+h;k+=app.pixelSize){var l=getLocColor(g,k),n=getRGBShader(l,g,k,a);if((!app.faceOnly||app.faceOnly&&g<=d+f&&k>=e&&g>=d&&k<=e+h)&&dist(red(l),green(l),blue(l),red(c),green(c),blue(c))<
app.cthresh){var m=millis()%app.meltTime;m=map(m,0,app.meltTime,0,app.meltLength+Math.round(random(0,15)));pg.push();pg.translate(g,k);app.rotate&&0==Math.round(random(10))%3&&pg.rotate(random(-.05,.05));pg.strokeWeight(app.pixelSize);pg.stroke(app.useShader?n:l);pg.line(0,0,0,0+m);pg.pop()}}push();scale(-1,1);image(b,-width,0);image(pg,-width,0);pop()}}function mouseClicked(){}
function keyPressed(){90==keyCode?app.useShader=!app.useShader:88==keyCode?app.rotate=!app.rotate:65==keyCode?app.ns=random(0,1)/100:70==keyCode&&(app.faceOnly=!app.faceOnly)}function getLocColor(a,b){var c=4*(a+b*capture.width);return color(capture.pixels[c],capture.pixels[c+1],capture.pixels[c+2])}function getShaderColor(a,b,c,d){var e=hue(a),f=saturation(a);a=brightness(a);var h=noise((e+b)*d,(e+c)*d),g=noise((f+b)*d,(f+c)*d);b=noise((a+b)*d,(a+c)*d);return a=color(e*h,f*g,a*b*2)}
function getRGBShader(a,b,c,d){var e=red(a),f=green(a),h=blue(a);if(d){a=noise((e+b)*d,(e+c)*d);var g=noise((f+b)*d,(f+c)*d);b=noise((h+b)*d,(h+c)*d);a=color(e*a,f*g,h*b);colorMode(HSB,100);a=color(hue(a),saturation(a),2*brightness(a));colorMode(RGB,255)}return a};